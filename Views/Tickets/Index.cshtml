@model IEnumerable<Assignment1.Models.Event>
@{
    ViewData["Title"] = "Tickets";
    var categories = ViewBag.Categories as string[] ?? Array.Empty<string>();
    var sortKey = ((string)ViewBag.Sort ?? "date").ToLower();

    // نمایش: اول رویدادهای کم‌بلیت، بعد بر اساس sort
    IEnumerable<Assignment1.Models.Event> sortedModel =
        sortKey switch
        {
            "alpha" => Model.OrderBy(e => e.AvailableTickets < 5 && e.AvailableTickets > 0 ? 0 : 1).ThenBy(e => e.Title),
            "price" => Model.OrderBy(e => e.AvailableTickets < 5 && e.AvailableTickets > 0 ? 0 : 1).ThenBy(e => e.Price ?? 0m),
            _       => Model.OrderBy(e => e.AvailableTickets < 5 && e.AvailableTickets > 0 ? 0 : 1).ThenBy(e => e.Date)
        };

    var lowTickets = sortedModel.Where(e => e.AvailableTickets < 5 && e.AvailableTickets > 0).ToList();
}

<h2 class="mb-4 text-center">Buy Tickets</h2>

<form method="get" class="row g-3 align-items-end mb-4">
    <!-- Search -->
    <div class="col-md-3">
        <label for="search" class="form-label">Search</label>
        <input type="text" name="search" id="search" value="@ViewBag.Search" class="form-control" placeholder="Search events..." />
    </div>

    <!-- Category -->
    <div class="col-md-2">
        <label for="category" class="form-label">Category</label>
        <select name="category" id="category" class="form-select">
            @foreach (var cat in categories)
            {
                <option value="@cat" selected="@(ViewBag.Category == cat)">@cat</option>
            }
        </select>
    </div>

    <!-- Start Date -->
    <div class="col-md-2">
        <label for="startDate" class="form-label">Start Date</label>
        <input type="date" name="startDate" id="startDate" value="@ViewBag.StartDate" class="form-control" />
    </div>

    <!-- End Date -->
    <div class="col-md-2">
        <label for="endDate" class="form-label">End Date</label>
        <input type="date" name="endDate" id="endDate" value="@ViewBag.EndDate" class="form-control" />
    </div>

    <!-- Sort -->
    <div class="col-md-2">
        <label for="sort" class="form-label">Sort By</label>
        <select name="sort" id="sort" class="form-select">
            <option value="date"  selected="@(ViewBag.Sort == "date")">Date</option>
            <option value="alpha" selected="@(ViewBag.Sort == "alpha")">Alphabetical (A–Z)</option>
            <option value="price" selected="@(ViewBag.Sort == "price")">Price</option>
        </select>
    </div>

    <!-- Buttons -->
    <div class="col-md-1 d-grid">
        <button type="submit" class="btn btn-primary">Filter</button>
    </div>
    <div class="col-md-1 d-grid">
        <a asp-action="Index" class="btn btn-outline-secondary">Reset</a>
    </div>
</form>

@if (lowTickets.Any())
{
    <div class="alert alert-warning text-center fw-bold shadow-sm mb-3">
        ⚠️ Some events are almost sold out! (Less than 5 tickets remaining)
    </div>
}

@if (!sortedModel.Any())
{
    <div class="alert alert-info text-center">No events found.</div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle shadow-sm">
            <thead class="table-light">
                <tr>
                    <th>Title</th>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Price ($)</th>
                    <th>Available</th>
                    <th class="text-center" style="width: 120px;">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var e in sortedModel)
                {
                    var isLow = e.AvailableTickets < 5 && e.AvailableTickets > 0;
                    var isSoldOut = e.AvailableTickets <= 0;

                    <!-- ✅ دیگه کل سطر برای Sold Out قرمز نمی‌شه -->
                    <tr class="@(isLow ? "low-tickets-row" : "")">
                        <td>@e.Title</td>
                        <td>@e.Date.ToLocalTime().ToString("yyyy-MM-dd hh:mm tt")</td>
                        <td class="text-truncate" style="max-width: 360px;">@e.Description</td>
                        <td>@e.Category</td>
                        <td>@(e.Price?.ToString("0.00") ?? "-")</td>
                        <td class="@(isLow ? "text-danger fw-bold" : "")">
                            @if (isSoldOut)
                            {
                                <!-- ✅ فقط برچسب Sold Out قاب خاکستری داشته باشه -->
                                <span class="badge-outline-gray">Sold Out</span>
                            }
                            else
                            {
                                @(isLow ? $"Only {e.AvailableTickets} left" : e.AvailableTickets.ToString())
                            }
                        </td>
                        <td class="text-center">
                            @if (isSoldOut)
                            {
                                <button class="btn btn-sm btn-secondary" disabled>Sold Out</button>
                            }
                            else
                            {
                                <!-- ✅ دکمه Buy سبز می‌مونه -->
                                <a asp-action="Buy" asp-route-id="@e.EventId" class="btn btn-sm btn-success">Buy</a>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

<style>
    /* ردیف رویدادهای کم‌بلیت (فقط کم‌ بلیت‌ها؛ نه sold out) */
    .low-tickets-row {
        border-top: 2px solid #dc3545 !important;
        border-bottom: 2px solid #dc3545 !important;
        background-color: #fff5f5 !important;
    }

    /* برچسب Sold Out با قاب خاکستری */
    .badge-outline-gray {
        display: inline-block;
        border: 1px solid #6c757d;
        color: #6c757d;
        background: transparent;
        border-radius: .375rem;
        padding: .15rem .5rem;
        font-size: .875rem;
        font-weight: 600;
        line-height: 1.2;
        white-space: nowrap;
    }
</style>
